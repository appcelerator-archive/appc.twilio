#!/usr/bin/env node

var fs = require('fs'),
	os = require('os'),
	path = require('path');

var appcJSONPath = path.join(__dirname, 'appc.json');
if (!fs.existsSync(appcJSONPath)) {
	process.exit(0);
}

var appcJSON = JSON.parse(fs.readFileSync(appcJSONPath));
var v8args = appcJSON && appcJSON.cloud && appcJSON.cloud.nodeargs || [];
var maxOldSpaceSizeIndex = v8args.indexOf('--max_old_space_size');

if (maxOldSpaceSizeIndex !== -1) {
	// if the user has more than 2GB of RAM, set the max memory to 75% of the total memory
	var totalMem = Math.floor(os.totalmem() / 1e6);
	var memToSet = (totalMem * 0.75).toFixed();
	if (memToSet > 1500) {
		v8args.splice(maxOldSpaceSizeIndex, 1, '--max_old_space_size=' + memToSet);
	} else {
		v8args.splice(maxOldSpaceSizeIndex, 1);
	}
}

var pkgPath = path.join(__dirname, 'package.json');
var arrowPkg = JSON.parse(fs.readFileSync(pkgPath));

if (arrowPkg && arrowPkg.scripts && arrowPkg.scripts.start && arrowPkg.scripts.start.indexOf('node') !== -1) {
	arrowPkg.scripts.start = 'node ' + v8args.join(' ') + ' ./__arrow_start.js;';
	var pkgContents = JSON.stringify(arrowPkg, null, 2);
	fs.writeFileSync(pkgPath, pkgContents);
}