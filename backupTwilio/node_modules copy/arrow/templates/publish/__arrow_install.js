#!/usr/bin/env node

var fs = require('fs'),
	path = require('path'),
	async = require('async'),
	exec = require('child_process').exec,
	tasks = [],
	bd = __dirname,
	nmd = path.join(bd,'node_modules');

[bd,nmd].forEach(function (cmd) {
	['connectors','blocks','models'].forEach(function (name) {
		var compdir = path.join(cmd,name);
		console.log(compdir);
		if (fs.existsSync(compdir)) {
			var compdirs = fs.readdirSync(compdir);
			if (compdirs.length) {
				compdirs.forEach(function (cn) {
					var cmd = path.join(compdir,cn);
					console.log('=>',cmd);
					if (fs.statSync(cmd).isDirectory()) {
						var pkg = path.join(cmd,'package.json');
						if (fs.existsSync(pkg)) {
							tasks.push(function (cb) {
								console.log('npm install --production',cmd);
								exec('npm install --production',{cwd:cmd},cb);
							});
						}
					}
				});
			}
		}
	});
});

if (tasks.length) {
	async.series(tasks,function(){
		process.exit(0);
	});
}
else {
	process.exit(0);
}

