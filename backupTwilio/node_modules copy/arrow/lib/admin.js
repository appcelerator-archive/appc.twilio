/**
 * This code is closed source and Confidential and Proprietary to
 * Appcelerator, Inc. All Rights Reserved.  This code MUST not be
 * modified, copied or otherwise redistributed without express
 * written permission of Appcelerator. This file is licensed as
 * part of the Appcelerator Platform and governed under the terms
 * of the Appcelerator license agreement.
 */
var path = require('path'),
	fs = require('fs'),
	chalk = require('chalk'),
	async = require('async'),
	adminapi = require('arrow-admin-api'),
	APIAdmin = require('arrow-admin'),
	APIAdmin2 = require('piedpiper-ui'),
	om = require('arrow-objectmodel'),
	cluster = require('cluster'),
	async = require('async'),
	_ = require('lodash'),
	express = require('express'),
	util = require('./admin/util'),
	objectModel,
	admin;

// jscs:disable jsDoc

function Admin() {}

/**
 * start the admin
 */
Admin.prototype.start = function (arrow, callback) {
	var app = arrow.app,
		prefix = arrow.config.admin.prefix || '/arrow',
		apiprefix = '/adminapi/v1',
		createprefix = '/api-create-ui',
		env = arrow.config.env,
		devmode = env === 'development',
		config = _.merge({
			apikey: arrow.config.apikey,
			apikey_production: arrow.config.apikey_production,
			apikey_preproduction: arrow.config.apikey_preproduction,
			apikey_development: arrow.config.apikey_development,
			routes: {},
			prefix: prefix,
			apiprefix: apiprefix,
			createprefix: createprefix,
			env: env
		}, arrow.config.admin || {});

	this.prefix = prefix;
	this.apiprefix = apiprefix;
	this.createprefix = createprefix;

	if (cluster.isWorker) {
		// this is just used for hashing so create a directory that is hashed
		// so that we don't have conflicts generating the documentation cache
		// with multiple workers trying to generate the same doc
		config.docsDir = String(cluster.worker.id);
	}

	// admin is completely disabled
	if (config.disableAuth && config.disableAPIDoc) {
		arrow.logger.info('Arrow admin and API docs are disabled');
		return callback();
	}

	if (devmode || config.enableAdminInProduction) {
		require('./admin/logs').configure(app, prefix, arrow, devmode);
		require('./admin/timeline').configure(app, prefix, arrow, devmode);
		require('./admin/testapi').configure(app, prefix, arrow, devmode);
	}

	if (devmode) {
		// configure admin api module
		adminapi.configure(app, apiprefix, arrow, devmode);
	}

	// for now, only generate in development or if explicitly enabled
	if (devmode || config.enableAdminInProduction) {

		// create the object model
		objectModel = new om.ObjectModel(arrow);

		// support fetching the object model from url
		app.get(prefix + '/isloggedin', function (req, resp) {
			return resp.json(util.isLoggedIn(req, arrow.config.session.secret));
		});

		// support fetching the object model from url
		app.get(prefix + '/objectmodel', function (req, resp) {
			// must either be local or logged in
			if (devmode || util.isLoggedIn(req, arrow.config.session.secret)) {
				//TODO: remove passwords
				return resp.json(objectModel);
			} else {
				// not allowed
				return util.unauthorized(resp);
			}
		});

		var testmsg;
		if (devmode && !config.enableAdminInProduction) {
			testmsg = chalk.grey('This will only be available on your dev environment. To enable in production, set ') + chalk.cyan('enableAdminInProduction') + chalk.grey(' in your config');
		} else if (!devmode && config.enableAdminInProduction) {
			testmsg = chalk.grey('Limited features are available in production.');
		}

		// set the baseurl for the server
		objectModel.baseurl = arrow.baseurl;
		objectModel.adminurl = arrow.adminurl;
		objectModel.apidocurl = arrow.apidocurl;

		async.series([
			function (cb) {
				if (devmode) {
					var admin2 = new APIAdmin2(express, arrow, app, objectModel, config, null, function (err) {
						arrow.logger.info('Preview the new API Builder UI at ' + chalk.yellow.underline(arrow.baseurl + createprefix) + '. ' + chalk.grey('This will only be available on your dev environment.'));
						cb(err);
					});
				} else {
					cb(); // No API Builder UI in production
				}
			},

			function (cb) {
				// load admin after any routes you want to execute before
				admin = new APIAdmin(express, arrow, app, objectModel, config, null, function (err) {
					if (!err) {
						// only allow reloading in development
						if (devmode) {
							// fired by the admin to reload the configuration and regenerate the docs, etc.
							arrow.on('reloaded', function (obj, err) {
								if (!err) {
									arrow.logger.debug('arrow reloaded');
									objectModel = new om.ObjectModel(arrow);
									admin.emit('reload', objectModel);
								} else {
									arrow.logger.debug('arrow reload error', err);
								}
							});
						}

						if (!config.disableAuth) {
							arrow.logger.info('Access the Arrow admin at ' + chalk.yellow.underline(objectModel.adminurl) + (testmsg ? '. ' + testmsg : ''));
						}
						if (!config.disableAPIDoc) {
							arrow.logger.info('Access the Arrow API doc at ' + chalk.yellow.underline(objectModel.apidocurl));
						}
					}
					cb(err);
				});
			}

		], callback);

	} else {
		callback();
	}
};

module.exports = Admin;
