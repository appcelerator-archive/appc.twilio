'use strict';

var esprima = require('esprima');

module.exports = function (src, file) {
    if (typeof src !== 'string') {
        src = String(src);
    }
    
    try {
        Function(src);
        return;
    }
    catch (err) {
        if (err.constructor.name !== 'SyntaxError') {
            throw err;
        }
        return errorInfo(src, file);
    }
};

function errorInfo (src, file) {
    try {
        esprima.parse(src);
        return;
    }
    catch (err) {
        return new ParseError(err, src, file);
    }
}

function ParseError (err, src, file) {
    SyntaxError.call(this);
    
    this.message = err.message.replace(/^Line \d+: /, '');
    
    this.line = err.lineNumber;
    this.column = err.column;
    
    this.annotated = 'ParseError: ' + this.message 
        + '\n'
        + '    at ' + (file || '(anonymous file)') + ':' + this.line + ':' + this.column
        + '\n'
        + '    ' + src.split('\n')[this.line - 1]
        + '\n'
        + new Array(this.column + 4).join(' ') + '^'
        + '\n'
    ;
}

ParseError.prototype = new SyntaxError();

ParseError.prototype.toString = function () {
    return this.annotated;
};

ParseError.prototype.inspect = function () {
    return this.annotated;
};