'use strict';

var u = require('../util.js'),
    path = require('path'),
    program = require('commander'),
    colors = require('colors'),
    logger = require('../logger.js'),
    fs = require('fs'),
    querystring = require('querystring'),
    logger = require('../logger'),
    post = require('../post'),
    request = require('request'),
    HandleResult = require('./handleResult');

function unpublish(args, program) {
    var globalConfig = u.getGlobalConfig(),
        defaultConfig = u.getDefaultConfig(),
        proxy = u.getProxy();

    if(proxy) {
        logger.debug('ACS CLI is using proxy: ' + proxy.server);
        proxy = proxy.url;
    }
    if(globalConfig.publishHost && !program.isCallback) {
        console.log(String(('Admin Hostname: ' + globalConfig.publishHost).grey));
    }

    var cookie = globalConfig.cookie ? String(globalConfig.cookie).split(';')[0] || [ 'connect-sid', '' ].join('=') : '';
    var appname = u.getAppName(args, program);

    var version = program.ver? program.ver: 'deployed';
    var reqpath = '/unpublish/' + appname + '/';
    var url = (globalConfig.publishHost || defaultConfig.publishHost) + ':' + (globalConfig.publishPort || defaultConfig.publishPort) + reqpath + version;

    if(program.org) {
        url += ('?orgid=' + program.org);
    }

    var HR = new HandleResult();
    HR.reqParams=['unpublish', args, program];

    HR.succeed = function(response, result) {
        console.log(result.message);
        process.exit();
    };

    request({
        uri: encodeURI(url),
        method: 'POST',
        proxy: proxy,
        headers: {
            'Cookie' : cookie,
            'Content-Type': 'application/x-www-form-urlencoded'
        }
    }, HR.handler);

}

exports.run = function(args, program) {
    unpublish(args, program);
};
