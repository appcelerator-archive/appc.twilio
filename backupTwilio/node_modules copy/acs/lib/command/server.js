'use strict';

var path = require('path'),
    util = require('../util'),
    fs = require('fs'),
    querystring = require('querystring'),
    request = require('request'),
    HandleResult = require('./handleResult'),
    logger = require('../logger');

exports.run = function(args, program) {
    var p,
        method,
        url,
        globalConfig = util.getGlobalConfig(),
        defaultConfig = util.getDefaultConfig(),
        proxy = util.getProxy();

    if(proxy) {
        logger.debug('ACS CLI is using proxy: ' + proxy.server);
        proxy = proxy.url;
    }
    if(globalConfig.publishHost && !program.isCallback) {
        console.log(String(('Admin Hostname: ' + globalConfig.publishHost).grey));
    }

    var op = null, va = null;
    if(program.set) {
        op = 'set';
        va = program.set;
        method = 'POST';
    } else if(program.restart) {
        op = 'restart';
        va = program.restart;
        method = 'POST';
    } else if(program.list) {
        op = 'list';
        method = 'GET';
    }

    if(op === null) {
        util.die('You must provide required argument and options to continue.');
    }

    var cookie = globalConfig.cookie ? String(globalConfig.cookie).split(';')[0] || [ 'connect-sid', '' ].join('=') : '';

    p = '/server';

    if(op === 'set' || op === 'restart') {
        var appname = util.getAppName(args, program);
        p += '/' +  appname + '/' + op;
    } else if (op === 'list') {
        p += '/' + op;
    }
    if(va) {
        p += '/' + va;
    }

    url = (globalConfig.publishHost || defaultConfig.publishHost) + ':' + (globalConfig.publishPort || defaultConfig.publishPort) + p;

    if(program.org) {
        url += ('?orgid=' + program.org);
    }

    var options = {
        uri: encodeURI(url),
        method: method,
        proxy: proxy,
        headers: {
            'Cookie': cookie,
            'Content-Type': 'application/x-www-form-urlencoded'
        }
    };

    function doChange() {
        var HR = new HandleResult();
        HR.reqParams=['server', args, program];
        options.method = method;
        request(options, HR.handler);
    }

    function confirm(callback) {
        program.prompt('Making changes to server size will redeploy your app. Proceed [yes/no]: ', function (val) {
            callback(val.trim());
        });
    }

    var HRC = new HandleResult();
    if(op === 'set') {
        HRC.reqParams=['server', args, program];
        HRC.checkResult = function(response, result) {
            if (!result.success) {
                if (result.errcode && result.errcode === 362) {   // set the same server size as it is
                    console.log(result.message);
                    process.exit();
                }
                if(result.message) {
                    util.die(result.message + ' ' + (result.extended || ''), result.errcode ? result.errcode : 1);
                } else {
                    util.die('Failed to get app deployment status: ' + result);
                }
            }
            if (result.message && result.message.deployed === true) {
                // app has been deployed
                process.stdin.resume();
                confirm(function checkAnswer(answer) {
                    if (answer === 'yes') {
                        doChange();
                    } else if (answer === 'no') {
                        process.exit();
                    } else {
                        console.log("Please type 'yes' or 'no'.");
                        confirm(checkAnswer)
                    }
                })
            } else {
                doChange();
            }
        };

        options.method = 'GET';
        request(options, HRC.handler);

    } else if(op === 'restart') {
        HRC.reqParams=['server', args, program];
        options.method = method;
        request(options, HRC.handler);

    } else {
        HRC.reqParams=['server', args, program];
        HRC.checkResult = function(response, result) {
            if (!result.success) {
                if(result.message) {
                    util.die(result.message + ' ' + (result.extended || ''), result.errcode ? result.errcode : 1);
                } else {
                    util.die('Failed to get server quotas: ' + result);
                }
            }

            if(!result.quotas || result.quotas.length === 0) {
                console.log('No quota info found.');
            } else {
                console.log(String('Server Quotas: '.cyan));
                result.quotas.forEach(function(quota) {
                    console.log(JSON.stringify(quota, null, 4));
                });
            }

            if (result.sizes.length > 0) {
                console.log();
                console.log('Server Size Definition: '.cyan);
                result.sizes.forEach(function(size) {
                    for(var key in size) {
                        var value = size[key];
                        key += ':';
                        // we assume that the server size key should no longer than 16 characters
                        for (var i = key.length; i <= 16; i++) {
                            key += ' ';
                        }

                        console.log(key + value);
                    }
                });
            }
        };
        request(options, HRC.handler);
    }
};