'use strict';

var path = require('path'),
    util = require('../util'),
    fs = require('fs'),
    querystring = require('querystring'),
    request = require('request'),
    HandleResult = require('./handleResult'),
    logger = require('../logger');

exports.run = function(args, program) {
    var p,
        url,
        globalConfig = util.getGlobalConfig(),
        defaultConfig = util.getDefaultConfig(),
        proxy = util.getProxy();

    if(proxy) {
        logger.debug('ACS CLI is using proxy: ' + proxy.server);
        proxy = proxy.url;
    }
    if(globalConfig.publishHost && !program.isCallback) {
        console.log(String(('Admin Hostname: ' + globalConfig.publishHost).grey));
    }

    var domainName = args[0];
    logger.warn('About to tranfer domain name: ' + domainName);

    var sourceApp, targetApp;
    if(!program.from || !program.to) {
        util.die('You must provide required argument and options to continue.');
    }
    sourceApp = program.from;
    targetApp = program.to;

    var cookie = globalConfig.cookie ? String(globalConfig.cookie).split(';')[0] || [ 'connect-sid', '' ].join('=') : '';

    p = '/transfer-domain/' + domainName + '/' + sourceApp + '/' + targetApp;

    url = (globalConfig.publishHost || defaultConfig.publishHost) + ':' + (globalConfig.publishPort || defaultConfig.publishPort) + p;

    if(program.org) {
        url += ('?orgid=' + program.org);
    }

    var HR = new HandleResult();

    HR.reqParams=['transfer-domain', args, program];
    request({
        uri: encodeURI(url),
        method: 'POST',
        proxy: proxy,
        headers: {
            'Cookie': cookie,
            'Content-Type': 'application/x-www-form-urlencoded'
        }
    }, HR.handler);
};